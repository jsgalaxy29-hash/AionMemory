name: Benchmarks

on:
  workflow_dispatch:

jobs:
  run-benchmarks:
    runs-on: ubuntu-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_NOLOGO: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100-preview.6.24452.5'
          global-json-file: global.json
          include-prerelease: true
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/*.props
            **/*.targets
            **/packages.lock.json

      - name: Restore
        run: dotnet restore AionMemory.slnx

      - name: Run benchmarks
        run: dotnet run --project tests/Aion.Benchmarks/Aion.Benchmarks.csproj --configuration Release -- --job short --iterationCount 1 --warmupCount 1

      - name: Publish artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: BenchmarkDotNet.Artifacts
