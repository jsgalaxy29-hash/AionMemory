@using System.Text.Json
@using Aion.Domain
@using Aion.Domain.Logic
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inherits OwningComponentBase
@implements IDisposable

<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h5>@ResolvedTable?.DisplayName</h5>
        <button class="button secondary" @onclick="Refresh">Actualiser</button>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Titre</th>
                @if (ResolvedTable is not null)
                {
                    @foreach (var field in ResolvedTable.Fields.Where(f => f.IsListVisible).Take(3))
                    {
                        <th>@field.Label</th>
                    }
                }
                <th>Créé le</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <Virtualize Context="item" ItemsProvider="LoadItems" @ref="VirtualizedRecords" ItemSize="54">
                <ItemContent>
                    @if (item is not null)
                    {
                        var payload = DynamicListLogic.DeserializePayload(item.DataJson);
                        <tr @onclick="() => OnSelect.InvokeAsync(item)" style="cursor:pointer;">
                            <td>@item.Id</td>
                            @if (ResolvedTable is not null)
                            {
                                @foreach (var field in ResolvedTable.Fields.Where(f => f.IsListVisible).Take(3))
                                {
                                    <td>@(payload.TryGetValue(field.Name, out var value) ? value : null)</td>
                                }
                            }
                            <td>@item.CreatedAt.ToLocalTime().ToString("g")</td>
                            <td style="text-align:right;">
                                <button class="button danger" @onclick="() => DeleteRecord(item)" @onclick:stopPropagation="true">Supprimer</button>
                            </td>
                        </tr>
                    }
                </ItemContent>
                <Placeholder>
                    <tr><td colspan="4">Chargement…</td></tr>
                </Placeholder>
            </Virtualize>
        </tbody>
    </table>
    <div class="text-muted" style="margin-top:4px;">@TotalCount enregistrement(s)</div>
</div>

@code {
    [Inject] public IRecordQueryService? InjectedRecordService { get; set; }
    [Inject] public IModuleViewService? InjectedViewService { get; set; }

    [Parameter] public STable? Table { get; set; }
    [Parameter] public Guid? TableId { get; set; }
    [Parameter] public string? TableName { get; set; }
    [Parameter] public IRecordQueryService? RecordService { get; set; }
    [Parameter] public IModuleViewService? ViewService { get; set; }
    [Parameter] public string? Filter { get; set; }
    [Parameter] public string? SortField { get; set; }
    [Parameter] public bool SortDescending { get; set; }
    [Parameter] public int PageSize { get; set; } = 25;
    [Parameter] public EventCallback<F_Record> OnSelect { get; set; }
    [Parameter] public EventCallback<Guid> OnDeleted { get; set; }

    private Virtualize<F_Record>? VirtualizedRecords { get; set; }
    private CancellationTokenSource? _refreshCts;
    private STable? LoadedTable { get; set; }
    private STable? ResolvedTable => Table ?? LoadedTable;
    private int TotalCount { get; set; }
    private IRecordQueryService? ActiveRecordService => RecordService ?? InjectedRecordService;
    private IModuleViewService? ActiveViewService => ViewService ?? InjectedViewService;

    protected override async Task OnParametersSetAsync()
    {
        await EnsureTableMetadataAsync();
        await Refresh();
    }

    private async Task Refresh()
    {
        _refreshCts?.Cancel();
        _refreshCts = new CancellationTokenSource();
        TotalCount = 0;

        if (VirtualizedRecords is not null)
        {
            await VirtualizedRecords.RefreshDataAsync();
        }
    }

    private async ValueTask<ItemsProviderResult<F_Record>> LoadItems(ItemsProviderRequest request)
    {
        using var linkedCts = _refreshCts is not null && !_refreshCts.IsCancellationRequested
            ? CancellationTokenSource.CreateLinkedTokenSource(request.CancellationToken, _refreshCts.Token)
            : null;
        var cancellation = linkedCts?.Token ?? request.CancellationToken;

        if (ResolvedTable is null || ActiveRecordService is null)
        {
            return new ItemsProviderResult<F_Record>(Array.Empty<F_Record>(), 0);
        }

        var take = Math.Min(PageSize, request.Count);
        var spec = new QuerySpec
        {
            View = Filter,
            OrderBy = SortField,
            Descending = SortDescending,
            Skip = request.StartIndex,
            Take = take
        };

        var page = await ActiveRecordService.QueryAsync(ResolvedTable.Id, spec, cancellation).ConfigureAwait(false);
        TotalCount = page.TotalCount;
        return new ItemsProviderResult<F_Record>(page.Items, page.TotalCount);
    }

    private async Task EnsureTableMetadataAsync()
    {
        if (ResolvedTable is not null)
        {
            return;
        }

        var viewService = ActiveViewService;
        if (viewService is null)
        {
            return;
        }

        if (TableId.HasValue)
        {
            LoadedTable = await viewService.GetTableAsync(TableId.Value).ConfigureAwait(false);
        }
        else if (!string.IsNullOrWhiteSpace(TableName))
        {
            LoadedTable = await viewService.GetTableByNameAsync(TableName).ConfigureAwait(false);
        }
    }

    private async Task DeleteRecord(F_Record record)
    {
        if (ResolvedTable is null || ActiveRecordService is null)
        {
            return;
        }

        await ActiveRecordService.DeleteAsync(ResolvedTable.Id, record.Id);
        await Refresh();
        await OnDeleted.InvokeAsync(record.Id);
    }

    public void Dispose()
    {
        _refreshCts?.Cancel();
        _refreshCts?.Dispose();
    }
}
