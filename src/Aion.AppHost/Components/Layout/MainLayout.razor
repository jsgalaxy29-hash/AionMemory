@using Aion.AppHost.Services
@using Aion.Domain
@inherits LayoutComponentBase
@implements IDisposable
@inject IMetadataService Metadata
@inject NavigationManager Navigation
@inject UiState State
@inject AiProviderSelector AiSelector
@inject WorkspaceSelectionState WorkspaceState
@inject FirstRunState FirstRunState
@inject AccessibilityState Accessibility
@inject IJSRuntime JsRuntime
@using System.Globalization

<div class="app-shell">
    <aside class="app-shell__nav">
        <div class="app-shell__brand" @onclick="NavigateHome">
            <strong>AionMemory</strong>
            <small class="text-muted">UI dynamique</small>
        </div>
        <div class="app-shell__nav-section">
            <div class="app-shell__nav-title">Navigation</div>
            <button class="button secondary full-width" @onclick="NavigateHome">Accueil</button>
            <button class="button secondary full-width" @onclick="NavigateDashboard">Dashboard</button>
            <button class="button secondary full-width" @onclick="NavigateTimeline">Timeline</button>
            @if (!Accessibility.SimplifiedNavigation)
            {
                <button class="button secondary full-width" @onclick="NavigateAutomations">Automatisations</button>
                <button class="button secondary full-width" @onclick="NavigateLinks">Graphe</button>
                <button class="button secondary full-width" @onclick="NavigateBackups">Backups</button>
                <button class="button secondary full-width" @onclick="NavigateAiDiagnostics">Diagnostics IA</button>
            }
        </div>
        @if (!Accessibility.SimplifiedNavigation)
        {
            <div class="app-shell__nav-section">
                <div class="app-shell__nav-title">
                    Modules
                    <button class="button ghost" title="Actualiser" @onclick="LoadModules">↻</button>
                </div>
                @if (IsLoadingModules)
                {
                    <p class="text-muted">Chargement…</p>
                }
                else if (Modules.Count == 0)
                {
                    <p class="text-muted">Aucun module disponible.</p>
                }
                else
                {
                    <ul class="app-shell__nav-list">
                        @foreach (var module in Modules)
                        {
                            var isActive = State.CurrentModule?.Id == module.Id;
                            <li class="@(isActive ? "active" : string.Empty)" @onclick="() => NavigateToModule(module)">
                                <div>@module.Name</div>
                                <small class="text-muted">@module.EntityTypes.Count() entité(s)</small>
                            </li>
                        }
                    </ul>
                }
            </div>
        }
        <div class="app-shell__nav-section">
            <div class="app-shell__nav-title">Accessibilité</div>
            <label class="text-muted" for="accessibility-theme">Thème</label>
            <select id="accessibility-theme" class="input" @bind="SelectedTheme">
                @foreach (var option in ThemeOptions)
                {
                    <option value="@option.Value">@option.Label</option>
                }
            </select>
            <label class="text-muted" for="accessibility-font-scale">Taille du texte</label>
            <select id="accessibility-font-scale" class="input" value="@Accessibility.FontScale.ToString(CultureInfo.InvariantCulture)" @onchange="OnFontScaleChanged">
                @foreach (var option in FontScaleOptions)
                {
                    <option value="@option.Value.ToString(CultureInfo.InvariantCulture)">@option.Label</option>
                }
            </select>
            <label class="app-shell__toggle">
                <input type="checkbox" @bind="IsSimplifiedNavigation" />
                <span>Navigation simplifiée</span>
            </label>
        </div>
    </aside>
    <section class="app-shell__content">
        <header class="app-shell__topbar">
            <div>
                <div class="text-muted">Contexte</div>
                <div class="app-shell__breadcrumb">
                    <span>@(State.CurrentModule?.Name ?? "Module inconnu")</span>
                    @if (State.CurrentEntity is not null)
                    {
                        <span>›</span>
                        <span>@State.CurrentEntity.Name</span>
                    }
                </div>
            </div>
            <div class="app-shell__topbar-actions">
                @if (!WorkspaceState.IsInitialized)
                {
                    <div class="text-muted">Chargement des profils…</div>
                }
                else
                {
                    <div style="display:flex; gap:8px; align-items:center;">
                        <label class="text-muted">Workspace</label>
                        <select class="input" @onchange="OnWorkspaceChanged">
                            @foreach (var workspace in WorkspaceState.Workspaces)
                            {
                                <option value="@workspace.Id" selected="@(WorkspaceState.CurrentWorkspace?.Id == workspace.Id)">@workspace.Name</option>
                            }
                        </select>
                        <label class="text-muted">Profil</label>
                        <select class="input" @onchange="OnProfileChanged">
                            @foreach (var profile in WorkspaceState.Profiles)
                            {
                                <option value="@profile.Id" selected="@(WorkspaceState.CurrentProfile?.Id == profile.Id)">@profile.DisplayName</option>
                            }
                        </select>
                    </div>
                }
                @if (!_aiStatus.IsConfigured)
                {
                    <div class="badge" style="background-color:#c0392b; color:#fff;" title="@_aiStatus.Reason">IA inactive</div>
                }
                @if (!Accessibility.SimplifiedNavigation)
                {
                    <button class="button secondary" @onclick="NavigateTrust">Pourquoi ?</button>
                    <button class="button secondary" @onclick="NavigateExtensions">Extensions</button>
                }
                <button class="button secondary" @onclick="NavigateModules">Modules</button>
                <button class="button" @onclick="NavigateMarketplace">Marketplace</button>
            </div>
        </header>
        <main class="app-shell__body">
            @Body
        </main>
    </section>
</div>

@code {
    private readonly List<S_Module> Modules = new();
    private CancellationTokenSource? _loadCts;
    private bool IsLoadingModules { get; set; }
    private AiConfigurationStatus _aiStatus = AiConfigurationStatus.Inactive();

    private AccessibilityTheme SelectedTheme
    {
        get => Accessibility.Theme;
        set => Accessibility.SetTheme(value);
    }

    private bool IsSimplifiedNavigation
    {
        get => Accessibility.SimplifiedNavigation;
        set => Accessibility.SetSimplifiedNavigation(value);
    }

    private static IReadOnlyList<(AccessibilityTheme Value, string Label)> ThemeOptions { get; } =
        new List<(AccessibilityTheme, string)>
        {
            (AccessibilityTheme.System, "Système"),
            (AccessibilityTheme.Light, "Clair"),
            (AccessibilityTheme.Dark, "Sombre"),
            (AccessibilityTheme.HighContrast, "Contraste élevé")
        };

    private static IReadOnlyList<(double Value, string Label)> FontScaleOptions { get; } =
        new List<(double, string)>
        {
            (1.0, "100%"),
            (1.15, "115%"),
            (1.3, "130%"),
            (1.5, "150%")
        };

    protected override async Task OnInitializedAsync()
    {
        if (!FirstRunState.IsCompleted)
        {
            Navigation.NavigateTo("/setup");
            return;
        }

        State.OnChange += StateHasChanged;
        WorkspaceState.OnChange += HandleWorkspaceStateChanged;
        Accessibility.OnChange += HandleAccessibilityChanged;
        _aiStatus = AiSelector.GetStatus();
        await WorkspaceState.InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ApplyAccessibilityAsync();
        }
    }

    private async Task LoadModules()
    {
        _loadCts?.Cancel();
        _loadCts = new CancellationTokenSource();
        IsLoadingModules = true;

        try
        {
            var modules = await Metadata.GetModulesAsync(_loadCts.Token).ConfigureAwait(false);
            Modules.Clear();
            Modules.AddRange(modules);
        }
        finally
        {
            IsLoadingModules = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void NavigateHome() => Navigation.NavigateTo("/");
    private void NavigateDashboard()
    {
        var target = State.CurrentModule?.Name?.ToLowerInvariant() ?? "global";
        Navigation.NavigateTo($"/dashboard/{target}");
    }
    private void NavigateTimeline() => Navigation.NavigateTo("/timeline");
    private void NavigateAutomations() => Navigation.NavigateTo("/automations");
    private void NavigateModules() => Navigation.NavigateTo("/modules");
    private void NavigateExtensions() => Navigation.NavigateTo("/extensions");
    private void NavigateMarketplace() => Navigation.NavigateTo("/marketplace");
    private void NavigateTrust() => Navigation.NavigateTo("/trust-ux");
    private void NavigateLinks() => Navigation.NavigateTo("/links");
    private void NavigateBackups() => Navigation.NavigateTo("/backups");
    private void NavigateAiDiagnostics() => Navigation.NavigateTo("/diagnostics/ai");

    private void NavigateToModule(S_Module module)
    {
        State.SetModule(module);
        State.SetEntity(module.EntityTypes.FirstOrDefault());
        Navigation.NavigateTo(UiRoutes.Module(module.Id));
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        State.OnChange -= StateHasChanged;
        WorkspaceState.OnChange -= HandleWorkspaceStateChanged;
        Accessibility.OnChange -= HandleAccessibilityChanged;
    }

    private async void HandleWorkspaceStateChanged()
    {
        State.SetModule(null);
        State.SetEntity(null);
        await LoadModules();
    }

    private async Task OnWorkspaceChanged(ChangeEventArgs args)
    {
        if (Guid.TryParse(args.Value?.ToString(), out var workspaceId))
        {
            await WorkspaceState.SelectWorkspaceAsync(workspaceId);
        }
    }

    private async Task OnProfileChanged(ChangeEventArgs args)
    {
        if (Guid.TryParse(args.Value?.ToString(), out var profileId))
        {
            await WorkspaceState.SelectProfileAsync(profileId);
        }
    }

    private void OnFontScaleChanged(ChangeEventArgs args)
    {
        if (double.TryParse(args.Value?.ToString(), NumberStyles.Float, CultureInfo.InvariantCulture, out var scale))
        {
            Accessibility.SetFontScale(scale);
        }
    }

    private async void HandleAccessibilityChanged()
    {
        await ApplyAccessibilityAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ApplyAccessibilityAsync()
    {
        await JsRuntime.InvokeVoidAsync("aionUi.applyAccessibility", new
        {
            theme = GetThemeToken(Accessibility.Theme),
            fontScale = Accessibility.FontScale,
            simplifiedNav = Accessibility.SimplifiedNavigation
        });
    }

    private static string GetThemeToken(AccessibilityTheme theme)
        => theme switch
        {
            AccessibilityTheme.Light => "light",
            AccessibilityTheme.Dark => "dark",
            AccessibilityTheme.HighContrast => "high-contrast",
            _ => "system"
        };
}
