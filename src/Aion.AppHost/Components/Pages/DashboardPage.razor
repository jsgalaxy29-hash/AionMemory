@page "/dashboard/{entity}"
@inject IDashboardService DashboardService
@inject IAgendaService AgendaService
@inject INoteService NoteService
@inject IRecordQueryService RecordQueries
@inject IModuleViewService ModuleViews
@implements IDisposable

<h3>Dashboard - @Entity</h3>
<div class="grid columns-3" style="gap:12px;">
    <div class="card">
        <h4>Résumé des données</h4>
        @if (!TableSummaries.Any())
        {
            <p class="text-muted">Aucune table disponible.</p>
        }
        else
        {
            <ul>
                @foreach (var summary in PagedTableSummaries)
                {
                    <li><strong>@summary.Name</strong> : @summary.Count enregistrement(s)</li>
                }
            </ul>
            <div class="list-pagination">
                <button class="button secondary" @onclick="PreviousTablePage" disabled="@(!CanGoPreviousTables)">◀</button>
                <span class="text-muted">Page @(TablePageIndex + 1) / @TotalTablePages</span>
                <button class="button secondary" @onclick="NextTablePage" disabled="@(!CanGoNextTables)">▶</button>
            </div>
        }
    </div>
    <div class="card">
        <h4>Événements à venir</h4>
        <ul>
            @foreach (var evt in PagedUpcomingEvents)
            {
                <li>@evt.Start.ToLocalTime().ToString("g") - @evt.Title</li>
            }
        </ul>
        <div class="list-pagination">
            <button class="button secondary" @onclick="PreviousEventPage" disabled="@(!CanGoPreviousEvents)">◀</button>
            <span class="text-muted">Page @(EventPageIndex + 1) / @TotalEventPages</span>
            <button class="button secondary" @onclick="NextEventPage" disabled="@(!CanGoNextEvents)">▶</button>
        </div>
    </div>
    <div class="card">
        <h4>Notes récentes</h4>
        <ul>
            @foreach (var note in PagedRecentNotes)
            {
                <li><strong>@note.Title</strong> - @note.CreatedAt.ToLocalTime().ToString("g")</li>
            }
        </ul>
        <div class="list-pagination">
            <button class="button secondary" @onclick="PreviousNotePage" disabled="@(!CanGoPreviousNotes)">◀</button>
            <span class="text-muted">Page @(NotePageIndex + 1) / @TotalNotePages</span>
            <button class="button secondary" @onclick="NextNotePage" disabled="@(!CanGoNextNotes)">▶</button>
        </div>
    </div>
</div>

<Dashboard DashboardService="DashboardService" />

@code {
    [Parameter] public string? Entity { get; set; }

    private const int TablePageSize = 6;
    private const int EventPageSize = 6;
    private const int NotePageSize = 6;

    private List<(string Name, int Count)> TableSummaries { get; set; } = new();
    private List<S_Event> UpcomingEvents { get; set; } = new();
    private List<S_Note> RecentNotes { get; set; } = new();
    private int TablePageIndex { get; set; }
    private int EventPageIndex { get; set; }
    private int NotePageIndex { get; set; }
    private CancellationTokenSource? _loadCts;

    private int TotalTablePages => Math.Max(1, (int)Math.Ceiling((double)Math.Max(TableSummaries.Count, 1) / TablePageSize));
    private int TotalEventPages => Math.Max(1, (int)Math.Ceiling((double)Math.Max(UpcomingEvents.Count, 1) / EventPageSize));
    private int TotalNotePages => Math.Max(1, (int)Math.Ceiling((double)Math.Max(RecentNotes.Count, 1) / NotePageSize));
    private bool CanGoPreviousTables => TablePageIndex > 0;
    private bool CanGoNextTables => TablePageIndex < TotalTablePages - 1;
    private bool CanGoPreviousEvents => EventPageIndex > 0;
    private bool CanGoNextEvents => EventPageIndex < TotalEventPages - 1;
    private bool CanGoPreviousNotes => NotePageIndex > 0;
    private bool CanGoNextNotes => NotePageIndex < TotalNotePages - 1;
    private IEnumerable<(string Name, int Count)> PagedTableSummaries
        => TableSummaries.Skip(TablePageIndex * TablePageSize).Take(TablePageSize);
    private IEnumerable<S_Event> PagedUpcomingEvents
        => UpcomingEvents.Skip(EventPageIndex * EventPageSize).Take(EventPageSize);
    private IEnumerable<S_Note> PagedRecentNotes
        => RecentNotes.Skip(NotePageIndex * NotePageSize).Take(NotePageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadTables();
        await LoadAgenda();
        await LoadNotes();
    }

    private async Task LoadTables()
    {
        _loadCts?.Cancel();
        _loadCts = new CancellationTokenSource();

        var tables = await ModuleViews.GetTablesAsync(_loadCts.Token);
        TableSummaries = new List<(string Name, int Count)>();
        foreach (var table in tables)
        {
            var total = await RecordQueries.CountAsync(table.Id, new QuerySpec { Projection = QueryProjection.List }, _loadCts.Token);
            TableSummaries.Add((table.DisplayName ?? table.Name, total));
        }

        TablePageIndex = Math.Min(TablePageIndex, TotalTablePages - 1);
    }

    private async Task LoadAgenda()
    {
        var now = DateTimeOffset.Now;
        _loadCts ??= new CancellationTokenSource();
        UpcomingEvents = (await AgendaService.GetOccurrencesAsync(now, now.AddDays(7), _loadCts.Token)).ToList();
        EventPageIndex = Math.Min(EventPageIndex, TotalEventPages - 1);
    }

    private async Task LoadNotes()
    {
        _loadCts ??= new CancellationTokenSource();
        var notesToFetch = Math.Max(NotePageSize * 3, 30);
        RecentNotes = (await NoteService.GetChronologicalAsync(notesToFetch, _loadCts.Token)).ToList();
        NotePageIndex = Math.Min(NotePageIndex, TotalNotePages - 1);
    }

    private Task PreviousTablePage()
    {
        if (CanGoPreviousTables)
        {
            TablePageIndex--;
        }

        return Task.CompletedTask;
    }

    private Task NextTablePage()
    {
        if (CanGoNextTables)
        {
            TablePageIndex++;
        }

        return Task.CompletedTask;
    }

    private Task PreviousEventPage()
    {
        if (CanGoPreviousEvents)
        {
            EventPageIndex--;
        }

        return Task.CompletedTask;
    }

    private Task NextEventPage()
    {
        if (CanGoNextEvents)
        {
            EventPageIndex++;
        }

        return Task.CompletedTask;
    }

    private Task PreviousNotePage()
    {
        if (CanGoPreviousNotes)
        {
            NotePageIndex--;
        }

        return Task.CompletedTask;
    }

    private Task NextNotePage()
    {
        if (CanGoNextNotes)
        {
            NotePageIndex++;
        }

        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }
}
