@page "/dashboard/{entity}"
@inject IDashboardService DashboardService
@inject IAgendaService AgendaService
@inject INoteService NoteService
@inject IRecordQueryService RecordQueries
@inject IModuleViewService ModuleViews
@implements IDisposable

<h3>Dashboard - @Entity</h3>
<div class="grid columns-3" style="gap:12px;">
    <div class="card">
        <h4>Résumé des données</h4>
        @if (!TableSummaries.Any())
        {
            <p class="text-muted">Aucune table disponible.</p>
        }
        else
        {
            <ul>
                @foreach (var summary in TableSummaries)
                {
                    <li><strong>@summary.Name</strong> : @summary.Count enregistrement(s)</li>
                }
            </ul>
        }
    </div>
    <div class="card">
        <h4>Événements à venir</h4>
        <ul>
            @foreach (var evt in UpcomingEvents)
            {
                <li>@evt.Start.ToLocalTime().ToString("g") - @evt.Title</li>
            }
        </ul>
    </div>
    <div class="card">
        <h4>Notes récentes</h4>
        <ul>
            @foreach (var note in RecentNotes)
            {
                <li><strong>@note.Title</strong> - @note.CreatedAt.ToLocalTime().ToString("g")</li>
            }
        </ul>
    </div>
</div>

<Dashboard DashboardService="DashboardService" />

@code {
    [Parameter] public string? Entity { get; set; }

    private List<(string Name, int Count)> TableSummaries { get; set; } = new();
    private IEnumerable<S_Event> UpcomingEvents { get; set; } = Array.Empty<S_Event>();
    private IEnumerable<S_Note> RecentNotes { get; set; } = Array.Empty<S_Note>();
    private CancellationTokenSource? _loadCts;

    protected override async Task OnInitializedAsync()
    {
        await LoadTables();
        await LoadAgenda();
        await LoadNotes();
    }

    private async Task LoadTables()
    {
        _loadCts?.Cancel();
        _loadCts = new CancellationTokenSource();

        var tables = await ModuleViews.GetTablesAsync(_loadCts.Token);
        TableSummaries = new List<(string Name, int Count)>();
        foreach (var table in tables)
        {
            var total = await RecordQueries.CountAsync(table.Id, new QuerySpec { Projection = QueryProjection.List }, _loadCts.Token);
            TableSummaries.Add((table.DisplayName ?? table.Name, total));
        }
    }

    private async Task LoadAgenda()
    {
        var now = DateTimeOffset.Now;
        _loadCts ??= new CancellationTokenSource();
        UpcomingEvents = await AgendaService.GetEventsAsync(now, now.AddDays(7), _loadCts.Token);
    }

    private async Task LoadNotes()
    {
        _loadCts ??= new CancellationTokenSource();
        RecentNotes = await NoteService.GetChronologicalAsync(10, _loadCts.Token);
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }
}
