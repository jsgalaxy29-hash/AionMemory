@page "/marketplace"
@using System.IO
@using System.Text.Json
@inject ITemplateService Templates
@inject IMetadataService Metadata
@inject IFileStorageService FileStorage
@inject IAionVisionService Vision
@inject IVisionSuggestionService VisionSuggestions
@inject NavigationManager Navigation

<h3>Catalogue templates</h3>
<p class="text-muted">Exportez, installez ou publiez vos modules sous forme de templates locaux.</p>

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="card" style="border:1px solid #e74c3c; background:#fff4f2;">
        <strong>Erreur :</strong> @ErrorMessage
    </div>
}

<div class="grid columns-2" style="gap:12px;">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
            <div>
                <h4 style="margin:0;">Marketplace locale</h4>
                <p class="text-muted" style="margin:0;">Templates présents dans le dossier marketplace.</p>
            </div>
            <button class="button secondary" @onclick="LoadMarketplace" disabled="@IsLoadingMarketplace">
                @(IsLoadingMarketplace ? "Chargement…" : "Rafraîchir")
            </button>
        </div>

        @if (IsLoadingMarketplace)
        {
            <p>Chargement des templates…</p>
        }
        else if (CatalogueItems.Count == 0)
        {
            <p>Aucun template détecté. Exportez un module ou ajoutez un fichier .json dans le dossier marketplace.</p>
        }
        else
        {
            <div class="grid columns-1" style="gap:8px;">
                @foreach (var item in CatalogueItems)
                {
                    <div class="card" style="background:#fafafa;">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
                            <div>
                                <strong>@item.Package.Name</strong>
                                <p class="text-muted" style="margin:0;">Module · v@item.Package.Version · @item.Package.Author</p>
                                <small class="text-muted">@item.FileName · @item.AssetCount asset(s)</small>
                            </div>
                            <button class="button" @onclick="() => ImportFromMarketplace(item)" disabled="@IsImporting">
                                @(IsImporting ? "Import…" : "Importer")
                            </button>
                        </div>
                    </div>
                }
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(MarketplaceStatus))
        {
            <p class="text-muted" style="margin-top:8px;">@MarketplaceStatus</p>
        }
    </div>

    <div class="card" style="display:flex; flex-direction:column; gap:8px;">
        <h4 style="margin:0;">Exporter / publier</h4>
        <p class="text-muted" style="margin:0;">Sélectionnez un module pour le transformer en template et l'ajouter au marketplace.</p>
        <select class="select" @bind="SelectedModuleId" disabled="@(Modules.Count == 0)">
            @foreach (var module in Modules)
            {
                <option value="@module.Id">@module.Name</option>
            }
        </select>
        <button class="button" @onclick="ExportSelectedModule" disabled="@(IsExporting || Modules.Count == 0)">
            @(IsExporting ? "Export en cours…" : "Exporter vers marketplace")
        </button>
        @if (!string.IsNullOrWhiteSpace(ExportStatus))
        {
            <p class="text-muted" style="margin:0;">@ExportStatus</p>
        }
    </div>
</div>

<div class="grid columns-2" style="gap:12px; margin-top:12px;">
    <div class="card" style="display:flex; flex-direction:column; gap:8px;">
        <h4 style="margin:0;">Importer un template</h4>
        <p class="text-muted" style="margin:0;">Chargez un fichier JSON de module (export AION ou marketplace) pour l'installer.</p>
        <InputFile OnChange="HandleTemplateUpload" />
        @if (!string.IsNullOrWhiteSpace(ImportStatus))
        {
            <p class="text-muted" style="margin:0;">@ImportStatus</p>
        }
    </div>

    <div class="card" style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
            <div>
                <h4 style="margin:0;">Vision IA</h4>
                <p class="text-muted" style="margin:0;">Envoyez une image ou un PDF pour lancer une analyse (OCR, résumé, etc.).</p>
            </div>
            <select class="select" @bind="SelectedAnalysisType">
                @foreach (var type in Enum.GetValues<VisionAnalysisType>())
                {
                    <option value="@type">@type</option>
                }
            </select>
        </div>
        <InputFile OnChange="HandleVisionUpload" />
        @if (!string.IsNullOrWhiteSpace(VisionStatus))
        {
            <p class="text-muted" style="margin:0;">@VisionStatus</p>
        }
        @if (VisionLabels.Count > 0)
        {
            <div style="display:flex; flex-wrap:wrap; gap:6px;">
                @foreach (var label in VisionLabels)
                {
                    <span class="badge">#@label.Label</span>
                }
            </div>
        }
        @if (VisionSuggestionEntries.Count > 0)
        {
            <div class="grid columns-1" style="gap:8px;">
                @foreach (var suggestion in VisionSuggestionEntries)
                {
                    <div class="card" style="background:#f9f9f9;">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
                            <div>
                                <strong>@suggestion.ModuleName</strong>
                                <p class="text-muted" style="margin:0;">@suggestion.Reason</p>
                                @if (!string.IsNullOrWhiteSpace(suggestion.SourceLabel))
                                {
                                    <small class="text-muted">Label: @suggestion.SourceLabel</small>
                                }
                            </div>
                            <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                <button class="button" @onclick="() => AcceptVisionSuggestion(suggestion)" disabled="@IsImporting">
                                    @(suggestion.ModuleId is null ? "Importer" : "Ouvrir")
                                </button>
                                <button class="button secondary" @onclick="() => RefuseVisionSuggestion(suggestion)">Refuser</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        @if (!string.IsNullOrWhiteSpace(VisionResult))
        {
            <pre style="white-space:pre-wrap; background:#f6f6f6; padding:8px; border-radius:4px;">@VisionResult</pre>
        }
    </div>
</div>

<div class="card" style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
    <button class="button secondary" @onclick="NavigateToModules">Ouvrir les modules</button>
    <button class="button secondary" @onclick="LoadModules" disabled="@IsLoadingModules">
        @(IsLoadingModules ? "Rafraîchissement…" : "Rafraîchir les modules")
    </button>
</div>

@code {
    private static readonly JsonSerializerOptions TemplateSerializerOptions = new(JsonSerializerDefaults.Web);
    private List<TemplateCatalogueItem> CatalogueItems { get; } = new();
    private List<S_Module> Modules { get; } = new();
    private Guid SelectedModuleId { get; set; }
    private VisionAnalysisType SelectedAnalysisType { get; set; } = VisionAnalysisType.Ocr;
    private string? ErrorMessage { get; set; }
    private string? ImportStatus { get; set; }
    private string? ExportStatus { get; set; }
    private string? MarketplaceStatus { get; set; }
    private string? VisionStatus { get; set; }
    private string? VisionResult { get; set; }
    private IReadOnlyCollection<VisionLabel> VisionLabels { get; set; } = Array.Empty<VisionLabel>();
    private List<VisionModuleSuggestion> VisionSuggestionEntries { get; } = new();
    private bool IsLoadingMarketplace { get; set; }
    private bool IsLoadingModules { get; set; }
    private bool IsExporting { get; set; }
    private bool IsImporting { get; set; }
    private bool IsProcessingVision { get; set; }
    private const long MaxUploadSize = 10 * 1024 * 1024;

    protected override async Task OnInitializedAsync()
    {
        await LoadModules();
        await LoadMarketplace();
    }

    private async Task LoadMarketplace()
    {
        try
        {
            ErrorMessage = null;
            MarketplaceStatus = null;
            IsLoadingMarketplace = true;
            CatalogueItems.Clear();
            var items = await Templates.GetMarketplaceAsync();
            foreach (var item in items.OrderBy(i => i.Name))
            {
                var package = await ReadTemplatePackage(item);
                CatalogueItems.Add(new TemplateCatalogueItem(item, package, GetAssetCount(package.AssetsManifest)));
            }

            MarketplaceStatus = $"{CatalogueItems.Count} template(s) disponible(s).";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Marketplace: {ex.Message}";
        }
        finally
        {
            IsLoadingMarketplace = false;
        }
    }

    private async Task LoadModules()
    {
        try
        {
            ErrorMessage = null;
            IsLoadingModules = true;
            Modules.Clear();
            var modules = await Metadata.GetModulesAsync();
            Modules.AddRange(modules.OrderBy(m => m.Name));
            SelectedModuleId = Modules.FirstOrDefault()?.Id ?? Guid.Empty;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Modules: {ex.Message}";
        }
        finally
        {
            IsLoadingModules = false;
        }
    }

    private async Task ExportSelectedModule()
    {
        if (SelectedModuleId == Guid.Empty)
        {
            ExportStatus = "Aucun module sélectionné.";
            return;
        }

        try
        {
            ErrorMessage = null;
            ExportStatus = null;
            IsExporting = true;
            var package = await Templates.ExportModuleAsync(SelectedModuleId);
            ExportStatus = $"Template exporté : {package.Name} (v{package.Version}).";
            await LoadMarketplace();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Export: {ex.Message}";
        }
        finally
        {
            IsExporting = false;
        }
    }

    private async Task HandleTemplateUpload(InputFileChangeEventArgs args)
    {
        try
        {
            ErrorMessage = null;
            ImportStatus = "Lecture du fichier…";
            IsImporting = true;
            var file = args.File;
            using var stream = new StreamReader(file.OpenReadStream(MaxUploadSize));
            var content = await stream.ReadToEndAsync();
            var package = ParseTemplatePackage(content, Path.GetFileNameWithoutExtension(file.Name), null);

            await ImportTemplatePackage(package, $"{file.Name} importé.");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Import fichier: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
        }
    }

    private async Task ImportFromMarketplace(TemplateCatalogueItem item)
    {
        try
        {
            ErrorMessage = null;
            IsImporting = true;
            ImportStatus = $"Lecture du package {item.Package.Name}…";
            await ImportTemplatePackage(item.Package, $"{item.Package.Name} installé depuis la marketplace.");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Import marketplace: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
        }
    }

    private async Task ImportTemplatePackage(TemplatePackage package, string successMessage)
    {
        var module = await Templates.ImportModuleAsync(package);
        ImportStatus = successMessage + $" Module créé : {module.Name}.";
        await LoadModules();
        await LoadMarketplace();
    }

    private static TemplatePackage ParseTemplatePackage(string content, string fallbackName, Guid? fallbackId)
    {
        TemplatePackage? package = null;
        try
        {
            package = JsonSerializer.Deserialize<TemplatePackage>(content, TemplateSerializerOptions);
        }
        catch (JsonException)
        {
        }

        if (package is null || string.IsNullOrWhiteSpace(package.Payload))
        {
            package = new TemplatePackage
            {
                Id = fallbackId ?? Guid.NewGuid(),
                Name = fallbackName,
                Description = "Import fichier",
                Payload = content,
                Version = "1.0.0"
            };
        }

        if (string.IsNullOrWhiteSpace(package.Name))
        {
            package.Name = fallbackName;
        }

        if (string.IsNullOrWhiteSpace(package.Version))
        {
            package.Version = "1.0.0";
        }

        if (string.IsNullOrWhiteSpace(package.Author))
        {
            package.Author = "unknown";
        }

        return package;
    }

    private static int GetAssetCount(string? assetsManifest)
    {
        if (string.IsNullOrWhiteSpace(assetsManifest))
        {
            return 0;
        }

        try
        {
            var manifest = JsonSerializer.Deserialize<TemplateAssetsManifest>(assetsManifest, TemplateSerializerOptions);
            return manifest?.Assets?.Count ?? 0;
        }
        catch (JsonException)
        {
            return 0;
        }
    }

    private static async Task<TemplatePackage> ReadTemplatePackage(MarketplaceItem item)
    {
        var content = await File.ReadAllTextAsync(item.PackagePath);
        return ParseTemplatePackage(content, item.Name, item.Id);
    }

    private sealed record TemplateCatalogueItem(MarketplaceItem MarketplaceItem, TemplatePackage Package, int AssetCount)
    {
        public string FileName => Path.GetFileName(MarketplaceItem.PackagePath);
    }

    private async Task HandleVisionUpload(InputFileChangeEventArgs args)
    {
        if (IsProcessingVision)
        {
            return;
        }

        try
        {
            ErrorMessage = null;
            VisionResult = null;
            VisionLabels = Array.Empty<VisionLabel>();
            VisionSuggestionEntries.Clear();
            VisionStatus = "Traitement du fichier…";
            IsProcessingVision = true;

            var file = args.File;
            await using var stream = file.OpenReadStream(MaxUploadSize);
            var saved = await FileStorage.SaveAsync(file.Name, stream, file.ContentType ?? "application/octet-stream");

            var analysis = await Vision.AnalyzeAsync(new VisionAnalysisRequest
            {
                FileId = saved.Id,
                AnalysisType = SelectedAnalysisType
            });

            VisionStatus = $"Analyse {SelectedAnalysisType} terminée.";
            VisionResult = analysis.ResultJson;
            var suggestionResult = await VisionSuggestions.SuggestModulesAsync(analysis);
            VisionLabels = suggestionResult.Labels;
            VisionSuggestionEntries.Clear();
            VisionSuggestionEntries.AddRange(suggestionResult.Suggestions);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Vision: {ex.Message}";
        }
        finally
        {
            IsProcessingVision = false;
        }
    }

    private async Task AcceptVisionSuggestion(VisionModuleSuggestion suggestion)
    {
        if (suggestion.ModuleId is not null)
        {
            Navigation.NavigateTo(UiRoutes.Module(suggestion.ModuleId.Value));
            return;
        }

        var template = FindTemplateForSuggestion(suggestion);
        if (template is null)
        {
            ImportStatus = $"Aucun template trouvé pour {suggestion.ModuleName}.";
            RefuseVisionSuggestion(suggestion);
            return;
        }

        try
        {
            IsImporting = true;
            ImportStatus = $"Installation du template {template.Package.Name}…";
            await ImportTemplatePackage(template.Package, $"{template.Package.Name} installé depuis la suggestion.");
            RefuseVisionSuggestion(suggestion);
        }
        finally
        {
            IsImporting = false;
        }
    }

    private void RefuseVisionSuggestion(VisionModuleSuggestion suggestion)
    {
        VisionSuggestionEntries.Remove(suggestion);
    }

    private TemplateCatalogueItem? FindTemplateForSuggestion(VisionModuleSuggestion suggestion)
    {
        return CatalogueItems.FirstOrDefault(item =>
            string.Equals(item.Package.Name, suggestion.ModuleName, StringComparison.OrdinalIgnoreCase)
            || string.Equals(item.Package.Name, suggestion.ModuleSlug, StringComparison.OrdinalIgnoreCase));
    }

    private void NavigateToModules() => Navigation.NavigateTo("/modules/home");
}
