@page "/module-builder"
@inject ModuleDesignerService Designer
@inject NavigationManager Navigation

<h3>Module Builder IA</h3>

<div class="card" style="display:flex; flex-direction:column; gap:8px;">
    <label for="prompt" style="font-weight:600;">Décrivez votre module</label>
    <textarea id="prompt" class="input" rows="6" placeholder="Ex: Crée-moi un module pour gérer ma cave à vin"
              @bind="Prompt"></textarea>
    <button class="button" @onclick="Generate" disabled="IsLoading">
        @(IsLoading ? "Génération en cours..." : "Générer le module")
    </button>
    @if (!string.IsNullOrWhiteSpace(Status))
    {
        <p class="text-muted">@Status</p>
    }
</div>

@if (!string.IsNullOrWhiteSpace(RawJson))
{
    <div class="card" style="margin-top:12px;">
        <h4>JSON généré</h4>
        <pre style="white-space:pre-wrap;">@RawJson</pre>
    </div>
}

@if (Module is not null)
{
    <div class="card" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h4>@Module.Name</h4>
                    <p class="text-muted">@Module.Description</p>
                </div>
                <button class="button secondary" @onclick="OpenModules">Ouvrir dans Modules</button>
            </div>

        @foreach (var entity in Module.EntityTypes)
        {
            <div class="card" style="background:#fafafa;">
                <div style="display:flex; justify-content:space-between;">
                    <strong>@entity.Name</strong>
                    <span class="badge">@entity.Fields.Count champ(s)</span>
                </div>
                <ul>
                    @foreach (var field in entity.Fields)
                    {
                        <li><strong>@field.Name</strong> - @field.DataType</li>
                    }
                </ul>

                @if (entity.Relations.Any())
                {
                    <div class="text-muted">
                        Relations:
                        <ul>
                            @foreach (var relation in entity.Relations)
                            {
                                <li>@relation.Kind vers @GetEntityName(relation.ToEntityTypeId) (@GetRoleName(relation))</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    private string Prompt { get; set; } = string.Empty;
    private string? RawJson { get; set; }
    private string? Status { get; set; }
    private bool IsLoading { get; set; }
    private S_Module? Module { get; set; }

    private string GetEntityName(Guid entityTypeId)
    {
        return Module?.EntityTypes.FirstOrDefault(e => e.Id == entityTypeId)?.Name
               ?? entityTypeId.ToString();
    }

    private static string GetRoleName(S_Relation relation)
        => string.IsNullOrWhiteSpace(relation.RoleName) ? "Relation" : relation.RoleName;

    private async Task Generate()
    {
        if (IsLoading)
        {
            return;
        }

        IsLoading = true;
        Status = "Génération du module...";
        Module = null;
        RawJson = null;

        try
        {
            var module = await Designer.CreateModuleFromPromptAsync(Prompt);
            Module = module;
            RawJson = Designer.LastGeneratedJson;
            Status = "Module généré et enregistré.";
        }
        catch (Exception ex)
        {
            Status = $"Erreur lors de la génération: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void OpenModules() => Navigation.NavigateTo("/modules");
}
