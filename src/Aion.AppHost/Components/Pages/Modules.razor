@page "/modules"
@inject IMetadataService Metadata
@inject ModuleDesignerService ModuleDesigner
@inject NavigationManager Navigation
@inject IRecordQueryService RecordQueries
@inject Aion.AppHost.Services.ITableDefinitionService Tables
@inject AiProviderSelector AiSelector
@implements IDisposable

<h3>Modules</h3>
<div class="card" style="margin-bottom:12px;">
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <input class="input" style="flex:1;" placeholder="Rechercher un module" @bind="Search" @bind:event="oninput" />
        <select class="select" @bind="Filter">
            <option value="recent">Récents</option>
            <option value="favorite">Favoris</option>
            <option value="all">Tous</option>
        </select>
        <button class="button" @onclick="GenerateModule" disabled="@(!_aiStatus.IsConfigured)">Créer Module par IA</button>
        <button class="button secondary" @onclick="NavigateToBuilder">Ouvrir Module Builder</button>
    </div>
    @if (!_aiStatus.IsConfigured)
    {
        <p class="text-muted" style="margin:0;">IA inactive : @_aiStatus.Reason</p>
    }
</div>

<div class="grid columns-3">
    @if (ModuleList is null)
    {
        <p>Chargement…</p>
    }
    else
    {
        @foreach (var module in FilteredModules)
        {
            <div class="card module-card">
                <div class="module-header">
                    <div>
                        <strong>@module.Name</strong>
                        <p class="text-muted">@module.Description</p>
                    </div>
                    <span class="badge">@module.EntityTypes.Count entités</span>
                </div>
                <div class="grid columns-2">
                    @foreach (var entity in module.EntityTypes)
                    {
                        <div class="stat-box">
                            <div style="font-weight:600">@entity.Name</div>
                            <small class="text-muted">@entity.Fields.Count champ(s) · @GetCount(entity.Id) enregistrement(s)</small>
                        </div>
                    }
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="button secondary" @onclick="() => OpenModule(module.Id)">Ouvrir</button>
                    <button class="button secondary" @onclick="() => OpenDashboard(module)">Dashboard</button>
                </div>
            </div>
        }
    }
</div>

@code {
    private IEnumerable<S_Module>? ModuleList;
    private readonly Dictionary<Guid, int> RecordCounts = new();
    private string Search { get; set; } = string.Empty;
    private string Filter { get; set; } = "recent";
    private AiConfigurationStatus _aiStatus = AiConfigurationStatus.Inactive();

    private IEnumerable<S_Module> FilteredModules =>
        string.IsNullOrWhiteSpace(Search)
            ? ModuleList ?? Array.Empty<S_Module>()
            : ModuleList?.Where(m => m.Name.Contains(Search, StringComparison.OrdinalIgnoreCase)) ?? Array.Empty<S_Module>();

    protected override async Task OnInitializedAsync()
    {
        _aiStatus = AiSelector.GetStatus();
        ModuleList = await Metadata.GetModulesAsync();
        await LoadRecordCounts();
    }

    private void OpenModule(Guid id) => Navigation.NavigateTo(UiRoutes.Module(id));

    private void OpenDashboard(S_Module module)
    {
        Navigation.NavigateTo($"/dashboard/{module.Name.ToLowerInvariant()}");
    }

    private async Task GenerateModule()
    {
        if (!_aiStatus.IsConfigured)
        {
            return;
        }

        var module = await ModuleDesigner.CreateModuleFromPromptAsync("Assistant quotidien");
        ModuleList = (ModuleList ?? Array.Empty<S_Module>()).Append(module).ToArray();
        await LoadRecordCounts();
    }

    private void NavigateToBuilder() => Navigation.NavigateTo("/module-builder");

    private async Task LoadRecordCounts()
    {
        if (ModuleList is null)
        {
            return;
        }

        using var cts = new CancellationTokenSource();
        foreach (var entity in ModuleList.SelectMany(m => m.EntityTypes))
        {
            await Tables.EnsureTableAsync(entity, cts.Token);
            var total = await RecordQueries.CountAsync(entity.Id, new QuerySpec { Projection = QueryProjection.List }, cts.Token);
            RecordCounts[entity.Id] = total;
        }
    }

    private int GetCount(Guid entityId) => RecordCounts.TryGetValue(entityId, out var count) ? count : 0;

    public void Dispose()
    {
        RecordCounts.Clear();
    }
}
