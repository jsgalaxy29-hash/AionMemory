@page "/notes/{entity}/{recordId}"
@page "/notes/table/{tableId:guid}/{recordId:guid}"
@inject INoteService NoteService
@inject IModuleViewService ModuleViews
@implements IDisposable

<h3>Notes pour @EffectiveEntity</h3>
<div class="card" style="margin-bottom:12px;">
    <div class="module-header">
        <div>
            <strong>Ajouter une note</strong>
            <p class="text-muted">Enregistrer un texte lié à l'entité.</p>
        </div>
        <button class="button" @onclick="CreateNote">Enregistrer</button>
    </div>
    <div class="grid columns-2" style="gap:12px;">
        <input class="input" placeholder="Titre" @bind="Title" />
        <textarea class="input" placeholder="Contenu" rows="3" @bind="Content"></textarea>
    </div>
    @if (!string.IsNullOrWhiteSpace(Status))
    {
        <p class="text-muted" style="margin-top:8px;">@Status</p>
    }
</div>

<DynamicTimeline NoteService="@NoteService"
                TargetType="@EffectiveEntity"
                TargetId="@RecordGuid"
                @ref="Timeline" />

@code {
    [Parameter] public string? Entity { get; set; }
    [Parameter] public string? RecordId { get; set; }
    [Parameter] public string? TableId { get; set; }

    private string Title { get; set; } = string.Empty;
    private string Content { get; set; } = string.Empty;
    private string? Status { get; set; }
    private DynamicTimeline? Timeline { get; set; }
    private Guid? RecordGuid => Guid.TryParse(RecordId, out var guid) ? guid : null;
    private STable? Table { get; set; }
    private string? EffectiveEntity => Entity ?? Table?.Name;
    private CancellationTokenSource? _loadCts;

    protected override async Task OnParametersSetAsync()
    {
        if (TableId is null || ModuleViews is null || !Guid.TryParse(TableId, out var parsedTableId))
        {
            return;
        }

        _loadCts?.Cancel();
        _loadCts = new CancellationTokenSource();
        Table = await ModuleViews.GetTableAsync(parsedTableId, _loadCts.Token);
        Entity ??= Table?.Name;
    }

    private async Task CreateNote()
    {
        if (NoteService is null || string.IsNullOrWhiteSpace(EffectiveEntity) || RecordGuid is null)
        {
            Status = "Impossible de créer la note : contexte incomplet.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Title) || string.IsNullOrWhiteSpace(Content))
        {
            Status = "Merci de renseigner un titre et un contenu.";
            return;
        }

        var links = new List<J_Note_Link>
        {
            new()
            {
                TargetType = EffectiveEntity!,
                TargetId = RecordGuid.Value
            }
        };

        var note = await NoteService.CreateTextNoteAsync(Title, Content, links);
        Status = $"Note {note.Id} enregistrée.";
        Title = string.Empty;
        Content = string.Empty;
        if (Timeline is not null)
        {
            await Timeline.RefreshInternal();
        }
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }
}
