@page "/potager/edit/{recordId?}"
@using Aion.Domain
@inject IMetadataService Metadata
@inject IRecordQueryService RecordQueries
@inject IModuleViewService ModuleViews
@inject Aion.AppHost.Services.ITableDefinitionService Tables
@inject NavigationManager Navigation
@implements IDisposable

<h3>Nouvelle culture</h3>
@if (PotagerTable is null)
{
    <p>Module Potager non disponible.</p>
}
else
{
    <DynamicForm Table="PotagerTable" RecordId="EditingRecordId" RecordService="RecordQueries" ViewService="ModuleViews" OnSaved="Saved" />
}

@code {
    [Parameter] public string? RecordId { get; set; }
    private S_EntityType? PotagerEntity { get; set; }
    private STable? PotagerTable { get; set; }
    private Guid? EditingRecordId { get; set; }
    private CancellationTokenSource? _loadCts;

    protected override async Task OnInitializedAsync()
    {
        _loadCts?.Cancel();
        _loadCts = new CancellationTokenSource();
        var modules = await Metadata.GetModulesAsync(_loadCts.Token);
        PotagerEntity = modules.FirstOrDefault(m => m.Name.Contains("Potager", StringComparison.OrdinalIgnoreCase))?.EntityTypes.FirstOrDefault();
        if (PotagerEntity is not null)
        {
            PotagerTable = await Tables.EnsureTableAsync(PotagerEntity, _loadCts.Token);
        }

        if (Guid.TryParse(RouteParamToGuid(RecordId), out var guid))
        {
            EditingRecordId = guid;
        }
    }

    private static string? RouteParamToGuid(string? value) => string.IsNullOrWhiteSpace(value) ? null : value;

    private void Saved(F_Record record)
    {
        if (PotagerTable is null)
        {
            return;
        }

        Navigation.NavigateTo(UiRoutes.RecordDetail(PotagerTable.Id, record.Id));
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }
}
