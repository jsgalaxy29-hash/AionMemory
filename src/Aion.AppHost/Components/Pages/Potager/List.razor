@page "/potager"
@using Aion.Domain
@inject IMetadataService Metadata
@inject IRecordQueryService RecordQueries
@inject IModuleViewService ModuleViews
@inject Aion.AppHost.Services.ITableDefinitionService Tables
@inject NavigationManager Navigation
@implements IDisposable

<h3>Potager</h3>
<div class="grid columns-2">
    <div class="card">
        <div class="module-header">
            <div>
                <h4>Liste des cultures</h4>
                <p class="text-muted">Vue générée dynamiquement depuis le module Potager</p>
            </div>
            <button class="button" @onclick="NewCulture">Ajouter</button>
        </div>
        @if (PotagerTable is null)
        {
            <p>Le module Potager n'est pas disponible.</p>
        }
        else
        {
            <DynamicList Table="PotagerTable" RecordService="RecordQueries" ViewService="ModuleViews" OnSelect="OpenRecord" />
        }
    </div>
    <div class="card">
        <h4>Timeline des soins</h4>
        @if (PotagerTable is not null)
        {
            <DynamicTimeline TargetType="@PotagerEntity?.Name" />
        }
    </div>
</div>

@code {
    private S_EntityType? PotagerEntity { get; set; }
    private STable? PotagerTable { get; set; }
    private CancellationTokenSource? _loadCts;

    protected override async Task OnInitializedAsync()
    {
        _loadCts?.Cancel();
        _loadCts = new CancellationTokenSource();
        var modules = await Metadata.GetModulesAsync(_loadCts.Token);
        PotagerEntity = modules.FirstOrDefault(m => m.Name.Contains("Potager", StringComparison.OrdinalIgnoreCase))?.EntityTypes.FirstOrDefault();
        if (PotagerEntity is not null)
        {
            PotagerTable = await Tables.EnsureTableAsync(PotagerEntity, _loadCts.Token);
        }
    }

    private void OpenRecord(F_Record record)
    {
        if (PotagerTable is null)
        {
            return;
        }

        Navigation.NavigateTo(UiRoutes.RecordDetail(PotagerTable.Id, record.Id));
    }

    private void NewCulture()
    {
        Navigation.NavigateTo($"/potager/edit");
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }
}
